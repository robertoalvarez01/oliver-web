{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _JSXStyle from \"styled-jsx/style\";\nimport React from \"react\";\nvar __jsx = React.createElement;\nimport { useEffect, useState } from 'react';\nimport CardUbicacion from '../../src/components/CardUbicacion/index';\nimport OpcionesEnvio from '../../src/components/OpcionesEnvio';\nimport ZonaEnvio from '../../src/components/ZonaEnvio';\nimport Head from '../../src/components/Head';\nimport DetalleProductos from '../../src/components/DetalleProductos';\nimport Error from '../../src/components/Error';\nimport { connect } from 'react-redux';\nimport * as usuarioActions from '../../store/actions/usuarioActions';\nimport { API, MP_AC_TOKEN, URL_PROCESAR_VENTA } from '../../config/index';\nimport Loader from '../../src/components/Loader/index';\nimport MediosDePago from '../../src/components/MediosDePago';\nimport Modal from '../../src/components/Modal'; //import Router from 'next/router';\n//import FormVenta from '../../src/components/FormVenta';\n\nvar Swal = require('sweetalert2');\n\nvar verificarSesion = usuarioActions.verificarSesion;\n\nvar Checkout = function Checkout(props) {\n  var _useState = useState(false),\n      error = _useState[0],\n      setError = _useState[1];\n\n  var _useState2 = useState(false),\n      loading = _useState2[0],\n      setLoading = _useState2[1];\n\n  var _useState3 = useState(false),\n      modalIsOpen = _useState3[0],\n      setModalIsOpen = _useState3[1]; //modal para mostrar el form de datos de tarjeta\n\n\n  useEffect(function () {\n    props.verificarSesion();\n    document.getElementsByTagName('body')[0].style.overflowY = 'scroll';\n  }, []); //console.log(URL_PROCESAR_VENTA);\n\n  var handleClick = function handleClick() {\n    var usuario = props.usuarioReducer.usuario;\n    var envio = props.enviosReducer.tipos;\n    var zona = props.zonasReducer.zona;\n    var _props$ventaReducer = props.ventaReducer,\n        tipoEnvio = _props$ventaReducer.tipoEnvio,\n        idZona = _props$ventaReducer.idZona,\n        idMedioPago = _props$ventaReducer.idMedioPago,\n        total = _props$ventaReducer.total,\n        subtotal = _props$ventaReducer.subtotal,\n        productos = _props$ventaReducer.productos,\n        porcentaje_descuento = _props$ventaReducer.porcentaje_descuento,\n        descuento = _props$ventaReducer.descuento,\n        totalEnvio = _props$ventaReducer.totalEnvio;\n\n    if (!envio.local) {\n      if (!usuario.address || usuario.address === '') return setError('Es obligatorio completar tu ubicación.');\n      if (!zona) return setError('En caso de no retirarlo por nuestro local, es obligatorio completar la zona de envío.');\n    }\n\n    setError(false);\n    setLoading(true);\n    var idUsuario = usuario.idUsuario,\n        token = usuario.token,\n        nombre = usuario.nombre,\n        email = usuario.email,\n        telefono = usuario.telefono,\n        address = usuario.address;\n\n    if (idMedioPago == '1') {\n      //guardo data de envio para luego de hacer el checkout de mercado pago, envio los datos al servidor para registrar la venta con el envio correspondiente.\n      localStorage.setItem('dataEnvio', JSON.stringify({\n        tipo: tipoEnvio,\n        zona: idZona\n      }));\n      var headers = new Headers();\n      headers.append('Authorization', \"Bearer \".concat(MP_AC_TOKEN));\n      headers.append(\"Content-Type\", \"application/json\");\n      var items = [];\n      productos.map(function (prd) {\n        items.push({\n          id: prd.idSubProducto,\n          title: prd.subProducto,\n          currency_id: \"ARS\",\n          picture_url: prd.foto,\n          description: prd.producto + ' (' + prd.tamaño + ')',\n          quantity: prd.cantidad,\n          unit_price: prd.precio\n        });\n      });\n      var preference = {\n        items: items,\n        payer: {\n          name: nombre,\n          email: email,\n          phone: {\n            area_code: \"11\",\n            number: telefono\n          },\n          address: {\n            street_name: address\n          }\n        },\n        back_urls: {\n          success: URL_PROCESAR_VENTA,\n          failure: URL_PROCESAR_VENTA,\n          pending: URL_PROCESAR_VENTA\n        },\n        payment_methods: {\n          excluded_payment_types: [{\n            id: \"ticket\"\n          }],\n          installments: 1\n        },\n        // notification_url: \"https://hookb.in/7ZZKJPB89aFa99D3y3eo\",\n        statement_descriptor: \"OLIVER_PETSHOP\",\n        external_reference: \"\",\n        shipments: {\n          mode: \"not_specified\",\n          cost: totalEnvio,\n          receiver_address: {\n            street_name: address\n          }\n        }\n      };\n      fetch('https://api.mercadopago.com/checkout/preferences', {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(preference)\n      }).then(function (res) {\n        return res.json();\n      }).then(function (data) {\n        window.location.assign(data.init_point);\n      });\n      return;\n    }\n\n    var dataToRequest = {\n      envio: {\n        idZona: idZona,\n        tipo: tipoEnvio\n      },\n      venta: {\n        subtotal: subtotal,\n        porcentaje_descuento: porcentaje_descuento,\n        descuento: descuento,\n        total: total,\n        idUsuario: idUsuario,\n        productos: productos,\n        idMedioPago: idMedioPago\n      }\n    };\n    return registrarVenta(dataToRequest, token);\n  };\n\n  var registrarVenta = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(data, token) {\n      var headers, url, reqVenta;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              headers = new Headers();\n              headers.append('token', token);\n              headers.append(\"Content-Type\", \"application/json\");\n              url = \"\".concat(API, \"/ventas/registrarVenta\");\n              _context.next = 7;\n              return fetch(url, {\n                headers: headers,\n                method: 'POST',\n                body: JSON.stringify(data)\n              });\n\n            case 7:\n              reqVenta = _context.sent;\n\n              if (reqVenta.status == 200) {\n                localStorage.removeItem('dataEnvio');\n                localStorage.removeItem('carrito');\n                Swal.fire('Listo', 'Su compra se ha registrado con éxito, solo resta que se dirija a nuestro local para hacerse con su producto.', 'success').then(function () {\n                  return window.location.assign('/');\n                });\n              } else {\n                setLoading(false);\n                Swal.fire('Error', 'Ha ocurrido un error al momento de registrar la venta, intentalo más tarde', 'error');\n              }\n\n              _context.next = 16;\n              break;\n\n            case 11:\n              _context.prev = 11;\n              _context.t0 = _context[\"catch\"](0);\n              setLoading(false);\n              Swal.fire('Error', 'Ha ocurrido un error al momento de registrar la venta, intentalo más tarde', 'error');\n              console.log(_context.t0.message);\n\n            case 16:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[0, 11]]);\n    }));\n\n    return function registrarVenta(_x, _x2) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  if (error) {\n    Swal.fire('Atención', error, 'warning').then(function () {\n      return setError(false);\n    });\n  }\n\n  var habilitarModal = function habilitarModal() {\n    setModalIsOpen(!modalIsOpen);\n  };\n\n  return !props.usuarioReducer.logueado ? __jsx(\"div\", {\n    className: \"mt-3\"\n  }, __jsx(Error, {\n    message: \"No puedes realizar una compra sin tener una sesi\\xF3n activa.\"\n  })) : __jsx(React.Fragment, null, loading ? __jsx(\"div\", {\n    className: \"container-loader\"\n  }, __jsx(Loader, null)) : null, __jsx(Head, {\n    title: \"Oliver Pet Shop\"\n  }), __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"container mb-4\"\n  }, __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"row\"\n  }, __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"col-12 col-md-8 pt-4\"\n  }, __jsx(\"h2\", {\n    className: \"jsx-2581472546\"\n  }, \"\\xDAltimos pasos para terminar tu compra\"), __jsx(CardUbicacion, null), __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"alert alert-warning mt-3\"\n  }, __jsx(\"b\", {\n    className: \"jsx-2581472546\"\n  }, \"Atenci\\xF3n:\"), \" S\\xED desea retirar su compra en nuestro local, no es necesario que seleccione una zona de env\\xEDo\"), __jsx(ZonaEnvio, null), __jsx(\"h2\", {\n    className: \"jsx-2581472546\" + \" \" + \"mt-5\"\n  }, \"Opciones de env\\xEDo\"), __jsx(OpcionesEnvio, null), __jsx(\"h2\", {\n    className: \"jsx-2581472546\" + \" \" + \"mt-5\"\n  }, \"Selecciona un medio de pago\"), __jsx(MediosDePago, null), __jsx(\"button\", {\n    type: \"button\",\n    onClick: handleClick,\n    id: \"btn-continuar\",\n    className: \"jsx-2581472546\" + \" \" + \"btn btn-primary\"\n  }, \"Continuar\"), __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"divTotalMobile\"\n  }, __jsx(\"span\", {\n    id: \"total\",\n    className: \"jsx-2581472546\"\n  }, \"$\", props.ventaReducer.total), __jsx(\"button\", {\n    type: \"button\",\n    onClick: handleClick,\n    className: \"jsx-2581472546\" + \" \" + \"btn btn-primary\"\n  }, \"Continuar\"))), __jsx(\"div\", {\n    className: \"jsx-2581472546\" + \" \" + \"col-12 col-md-4 detalleProductos\"\n  }, __jsx(DetalleProductos, null))), __jsx(_JSXStyle, {\n    id: \"2581472546\"\n  }, [\"h2.jsx-2581472546{font-size:25px;}\", \"button#btn-continuar.jsx-2581472546{float:right;margin-top:20px;}\", \".divTotalMobile.jsx-2581472546{display:none;}\", \"@media(max-width:768px){#btn-continuar.jsx-2581472546{display:none;}.divTotalMobile.jsx-2581472546{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;position:fixed;left:0;right:0px;bottom:0px;background-color:#f7f7f7;padding:16px;box-shadow:0 -2px 8px 2px rgba(0,0,0,.15);border-width:0 1px 1px;font-family:'Quicksand',sans-serif;}.detalleProductos.jsx-2581472546{display:none;}}\"])), modalIsOpen ? __jsx(Modal, {\n    closeModal: habilitarModal\n  }, __jsx(FormVenta, {\n    closeModal: habilitarModal\n  })) : null);\n};\n\nvar mapStateToProps = function mapStateToProps(_ref2) {\n  var usuarioReducer = _ref2.usuarioReducer,\n      enviosReducer = _ref2.enviosReducer,\n      ventaReducer = _ref2.ventaReducer,\n      zonasReducer = _ref2.zonasReducer;\n  return {\n    ventaReducer: ventaReducer,\n    usuarioReducer: usuarioReducer,\n    enviosReducer: enviosReducer,\n    zonasReducer: zonasReducer\n  };\n};\n\nvar mapDispatchToProps = {\n  verificarSesion: verificarSesion\n};\nexport default connect(mapStateToProps, mapDispatchToProps)(Checkout);","map":null,"metadata":{},"sourceType":"module"}